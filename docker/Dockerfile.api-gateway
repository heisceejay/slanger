# ── Stage 1: Build ─────────────────────────────────────────────────────────
FROM node:22-alpine AS builder

WORKDIR /app

# Copy workspace manifests first for layer caching
COPY package.json package-lock.json ./
COPY packages/shared-types/package.json ./packages/shared-types/
COPY packages/api-gateway/package.json ./packages/api-gateway/
COPY packages/phonology/package.json ./packages/phonology/
COPY packages/morphology/package.json ./packages/morphology/
COPY packages/syntax/package.json ./packages/syntax/
COPY packages/lexicon/package.json ./packages/lexicon/
COPY packages/validation/package.json ./packages/validation/
COPY packages/llm-orchestrator/package.json ./packages/llm-orchestrator/

RUN npm ci --workspace=packages/shared-types \
           --workspace=packages/api-gateway \
           --workspace=packages/phonology \
           --workspace=packages/morphology \
           --workspace=packages/syntax \
           --workspace=packages/lexicon \
           --workspace=packages/validation \
           --workspace=packages/llm-orchestrator

# Copy source
COPY tsconfig.base.json ./
COPY packages/shared-types ./packages/shared-types/
COPY packages/api-gateway ./packages/api-gateway/
COPY packages/phonology ./packages/phonology/
COPY packages/morphology ./packages/morphology/
COPY packages/syntax ./packages/syntax/
COPY packages/lexicon ./packages/lexicon/
COPY packages/validation ./packages/validation/
COPY packages/llm-orchestrator ./packages/llm-orchestrator/

# Build all packages in dependency order
RUN npm run build -w packages/shared-types && \
    npm run build -w packages/phonology && \
    npm run build -w packages/morphology && \
    npm run build -w packages/syntax && \
    npm run build -w packages/lexicon && \
    npm run build -w packages/validation && \
    npm run build -w packages/llm-orchestrator && \
    npm run build -w packages/api-gateway

# ── Stage 2: Production image ───────────────────────────────────────────────
FROM node:22-alpine AS production

# Non-root user for security
RUN addgroup -g 1001 -S slanger && adduser -u 1001 -S slanger -G slanger

WORKDIR /app

# Copy only production artifacts
COPY --from=builder --chown=slanger:slanger /app/package.json ./
COPY --from=builder --chown=slanger:slanger /app/packages/shared-types/dist ./packages/shared-types/dist/
COPY --from=builder --chown=slanger:slanger /app/packages/shared-types/package.json ./packages/shared-types/
COPY --from=builder --chown=slanger:slanger /app/packages/api-gateway/dist ./packages/api-gateway/dist/
COPY --from=builder --chown=slanger:slanger /app/packages/api-gateway/package.json ./packages/api-gateway/
COPY --from=builder --chown=slanger:slanger /app/packages/phonology/dist ./packages/phonology/dist/
COPY --from=builder --chown=slanger:slanger /app/packages/phonology/package.json ./packages/phonology/
COPY --from=builder --chown=slanger:slanger /app/packages/morphology/dist ./packages/morphology/dist/
COPY --from=builder --chown=slanger:slanger /app/packages/morphology/package.json ./packages/morphology/
COPY --from=builder --chown=slanger:slanger /app/packages/syntax/dist ./packages/syntax/dist/
COPY --from=builder --chown=slanger:slanger /app/packages/syntax/package.json ./packages/syntax/
COPY --from=builder --chown=slanger:slanger /app/packages/lexicon/dist ./packages/lexicon/dist/
COPY --from=builder --chown=slanger:slanger /app/packages/lexicon/package.json ./packages/lexicon/
COPY --from=builder --chown=slanger:slanger /app/packages/validation/dist ./packages/validation/dist/
COPY --from=builder --chown=slanger:slanger /app/packages/validation/package.json ./packages/validation/
COPY --from=builder --chown=slanger:slanger /app/packages/llm-orchestrator/dist ./packages/llm-orchestrator/dist/
COPY --from=builder --chown=slanger:slanger /app/packages/llm-orchestrator/package.json ./packages/llm-orchestrator/

# Install production dependencies only
RUN npm ci --omit=dev --workspaces

USER slanger

EXPOSE 3001

HEALTHCHECK --interval=30s --timeout=10s --start-period=15s --retries=3 \
  CMD wget --quiet --tries=1 --spider http://localhost:3001/health || exit 1

CMD ["node", "packages/api-gateway/dist/index.js"]
